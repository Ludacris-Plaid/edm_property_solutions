<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Synapse Realty — Distressed Lead Engine</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&family=Orbitron:wght@500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link rel="icon" href="./assets/logo.svg" type="image/svg+xml">
<link rel="icon" href="./assets/logo.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="./assets/logo.png">
<style>
body { padding-top: 96px; background: #f7f9fc; }
.card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.chat-messages { height: 360px; overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 1rem; }
.msg { max-width: 85%; padding: 0.65rem 1rem; border-radius: 18px; margin: 0.4rem 0; word-wrap: break-word; }
.msg.user { background: #2DB5E5; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
.msg.bot { background: white; border: 1px solid #e0e0e0; margin-right: auto; border-bottom-left-radius: 4px; }
.thumb { width: 70px; height: 50px; object-fit: cover; border-radius: 6px; }
.reason-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; margin: 2px; display: inline-block; }
.bg-orange { background: #fd7e14 !important; color: white; }
.bg-purple { background: #6f42c1 !important; color: white; }
.bg-red { background: #dc3545 !important; color: white; }
.score-badge { font-size: 1.1rem; font-weight: 700; padding: .38rem .55rem; border-radius: 8px; }
code { background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 4px; font-size: .9em; }
@media (max-width: 991.98px){
  body { padding-top: 120px; }
}
/* Dark mode overrides for chat readability */
body.dark-mode { background:#0b0e11; }
body.dark-mode .card { background-color:#101419; color:#e9ecef; }
body.dark-mode .chat-messages { background:#0f1317; }
body.dark-mode .msg.bot { background:#1a1f24; color:#e9ecef; border-color:#2a2f36; }
body.dark-mode .msg.user { background:#2DB5E5; color:#fff; }
body.dark-mode .table { color:#e9ecef; }
/* Improve visibility of fluorescent green accents in dark mode */
body.dark-mode a, body.dark-mode .text-success { color:#62ffa8 !important; }
body.dark-mode .btn-outline-success { color:#62ffa8; border-color:#62ffa8; }
body.dark-mode .badge.bg-success, body.dark-mode .reason-tag.bg-success { filter: brightness(1.2) saturate(1.2); outline:1px solid rgba(255,255,255,0.18); }

</style>
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="index.html">
        <img src="./assets/logo.svg" alt="Synapse Realty Systems" class="brand-logo" onerror="this.src='./assets/logo.png'">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li><a class="nav-link nav-icon" href="index.html" title="Home" aria-label="Home"><i class="fa-solid fa-house"></i></a></li>
          <li><a class="nav-link nav-icon" href="about.html" title="About" aria-label="About"><i class="fa-solid fa-circle-info"></i></a></li>
          <li><a class="nav-link nav-icon" href="how-it-works.html" title="How It Works" aria-label="How It Works"><i class="fa-solid fa-gears"></i></a></li>
          <li><a class="nav-link nav-icon" href="contact.html" title="Contact" aria-label="Contact"><i class="fa-solid fa-paper-plane"></i></a></li>
          <li><a class="nav-link nav-icon active" href="admin.html" title="Admin" aria-label="Admin"><i class="fa-solid fa-screwdriver-wrench"></i></a></li>
          <li>
            <button id="themeBtn" class="btn btn-link ms-2" title="Toggle Theme" aria-label="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<!-- PIN Overlay (shown only if not unlocked) -->
<div id="pinOverlay" class="pin-overlay hidden" aria-hidden="true">
  <div class="pin-card">
    <h2>Enter Admin PIN</h2>
    <p class="mb-3">This area is protected. Please enter your admin PIN to continue.</p>
    <input id="pinInput" type="password" placeholder="Enter PIN" aria-label="Admin PIN" />
    <button id="pinSubmit" class="btn btn-success mt-3">Unlock</button>
    <div id="pinError" class="pin-error"></div>
  </div>
</div>

<div class="container py-4">
  <div class="row g-4">
    <!-- AI Panel -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Command Center</h5>
          <button id="clearChat" class="btn btn-sm btn-outline-light">Clear</button>
        </div>
        <div class="card-body d-flex flex-column">
          <div id="chatBox" class="chat-messages mb-3 flex-grow-1" aria-live="polite"></div>
          <div class="input-group">
            <input id="cmdInput" class="form-control" placeholder="Try: fetch zillow for Edmonton AB under 400k  |  fetch redfin region 33_2924" autocomplete="off">
            <button id="sendBtn" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
          </div>
          <small class="text-muted mt-2">Try: <code>fetch zillow for Calgary AB under 500k 3 beds</code></small>
        </div>
      </div>
    </div>

    <!-- Properties Table -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-white text-dark d-flex justify-content-between align-items-center border-bottom">
          <h5 class="mb-0"><i class="fas fa-fire me-2 text-primary"></i>Hot Distressed Properties</h5>
          <div class="d-flex align-items-center gap-2">
            <button id="exportBtn" class="btn btn-sm btn-outline-success" title="Export visible rows to CSV"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
            <button id="sendCarouselBtn" class="btn btn-sm btn-outline-primary" title="Send top visible to homepage carousel"><i class="fas fa-photo-film me-1"></i>Send to Carousel</button>
            <button id="clearBtn" class="btn btn-sm btn-outline-danger" title="Clear all rows"><i class="fas fa-trash me-1"></i>Clear</button>
            <select id="sortSelect" class="form-select form-select-sm" style="width:180px">
              <option value="score_desc">Sort: Score (High→Low)</option>
              <option value="dom_desc">Sort: DOM (Long→Short)</option>
            </select>
            <input type="text" id="searchBox" class="form-control form-control-sm" style="width:260px" placeholder="Search address...">
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Photo</th>
                  <th>Address</th>
                  <th class="text-end">Price</th>
                  <th>Beds</th>
                  <th>Baths</th>
                  <th>Minutes</th>
                  <th>Score</th>
                  <th>Reasons</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="9" class="text-center py-5 text-muted">Type a command to load live data — e.g., <code>fetch zillow for Calgary AB</code> or <code>fetch redfin region 33_2924</code></td></tr>
              </tbody>
            </table>
          </div>
          <div class="border-top px-3 py-2 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button id="prevPage" class="btn btn-sm btn-outline-secondary" onclick="prevPage()">Prev</button>
              <span class="small" id="pageInfo">1 / 1</span>
              <button id="nextPage" class="btn btn-sm btn-outline-secondary" onclick="nextPage()">Next</button>
              <div class="d-flex align-items-center gap-2">
                <label for="pageJump" class="small text-muted mb-0">Jump</label>
                <input id="pageJump" type="number" min="1" class="form-control form-control-sm" style="width: 88px" placeholder="Page">
                <button class="btn btn-sm btn-outline-primary" onclick="jumpToPageInput()">Go</button>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="pageSizeSelect" class="small text-muted mb-0">Page size</label>
              <select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto; min-width: 80px">
                <option value="15" selected>15</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Deal Simulator + Live Stats -->
<div class="container py-3">
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa-solid fa-calculator me-2 text-primary"></i>Deal Simulator</h5>
          <small class="text-muted">Quickly underwrite a deal</small>
        </div>
        <div class="card-body">
          <form id="dealSimForm" class="row g-2">
            <div class="col-6">
              <label class="form-label">Price</label>
              <input id="sim_price" type="number" class="form-control" placeholder="350000" value="350000">
            </div>
            <div class="col-6">
              <label class="form-label">Rent (Monthly)</label>
              <input id="sim_rent" type="number" class="form-control" placeholder="2300" value="2300">
            </div>
            <div class="col-4">
              <label class="form-label">Down %</label>
              <input id="sim_down" type="number" class="form-control" placeholder="20" value="20">
            </div>
            <div class="col-4">
              <label class="form-label">Rate % (APR)</label>
              <input id="sim_rate" type="number" step="0.01" class="form-control" placeholder="6.5" value="6.5">
            </div>
            <div class="col-4">
              <label class="form-label">Term (yrs)</label>
              <input id="sim_term" type="number" class="form-control" placeholder="30" value="30">
            </div>
            <div class="col-4">
              <label class="form-label">Taxes /mo</label>
              <input id="sim_taxes" type="number" class="form-control" placeholder="250" value="250">
            </div>
            <div class="col-4">
              <label class="form-label">Insurance /mo</label>
              <input id="sim_ins" type="number" class="form-control" placeholder="110" value="110">
            </div>
            <div class="col-4">
              <label class="form-label">HOA /mo</label>
              <input id="sim_hoa" type="number" class="form-control" placeholder="0" value="0">
            </div>
            <div class="col-4">
              <label class="form-label">Vacancy %</label>
              <input id="sim_vac" type="number" class="form-control" placeholder="5" value="5">
            </div>
            <div class="col-4">
              <label class="form-label">Maint. %</label>
              <input id="sim_maint" type="number" class="form-control" placeholder="8" value="8">
            </div>
            <div class="col-4">
              <label class="form-label">Mgmt %</label>
              <input id="sim_mgmt" type="number" class="form-control" placeholder="8" value="8">
            </div>
            <div class="col-6">
              <label class="form-label">ARV</label>
              <input id="sim_arv" type="number" class="form-control" placeholder="400000" value="400000">
            </div>
            <div class="col-6">
              <label class="form-label">Rehab</label>
              <input id="sim_rehab" type="number" class="form-control" placeholder="25000" value="25000">
            </div>
            <div class="col-6">
              <label class="form-label">Closing % (buy)</label>
              <input id="sim_closing" type="number" class="form-control" placeholder="3" value="3">
            </div>
            <div class="col-6">
              <label class="form-label">Desired Profit</label>
              <input id="sim_profit" type="number" class="form-control" placeholder="15000" value="15000">
            </div>
          </form>
          <hr>
          <div class="row g-3" id="dealSimOutputs">
            <div class="col-6">
              <div class="p-3 rounded border" id="out_pi"><div class="text-muted">P&I</div><div class="fs-5 fw-bold">$0</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border" id="out_piti"><div class="text-muted">PITI</div><div class="fs-5 fw-bold">$0</div></div>
            </div>
            <div class="col-4">
              <div class="p-3 rounded border" id="out_dscr"><div class="text-muted">DSCR</div><div class="fs-5 fw-bold">0.00</div></div>
            </div>
            <div class="col-4">
              <div class="p-3 rounded border" id="out_cap"><div class="text-muted">Cap Rate</div><div class="fs-5 fw-bold">0.0%</div></div>
            </div>
            <div class="col-4">
              <div class="p-3 rounded border" id="out_coc"><div class="text-muted">Cash-on-Cash</div><div class="fs-5 fw-bold">0.0%</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border" id="out_cf"><div class="text-muted">Monthly Cash Flow</div><div class="fs-5 fw-bold">$0</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border" id="out_mao"><div class="text-muted">Max Offer (70% Rule)</div><div class="fs-5 fw-bold">$0</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa-solid fa-chart-line me-2 text-success"></i>Live Stats</h5>
          <small class="text-muted">Based on current table</small>
        </div>
        <div class="card-body">
          <div class="row g-3" id="liveStats">
            <div class="col-6">
              <div class="p-3 rounded border"><div class="text-muted">Total Leads</div><div id="stat_count" class="fs-4 fw-bold">0</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border"><div class="text-muted">Avg Score</div><div id="stat_avgscore" class="fs-4 fw-bold">0</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border"><div class="text-muted">Avg Price</div><div id="stat_avgprice" class="fs-4 fw-bold">$0</div></div>
            </div>
            <div class="col-6">
              <div class="p-3 rounded border"><div class="text-muted">Median Minutes</div><div id="stat_medmins" class="fs-4 fw-bold">0</div></div>
            </div>
            <div class="col-12">
              <div class="p-3 rounded border">
                <div class="text-muted mb-1">Score Sparkline</div>
                <svg id="stat_spark" viewBox="0 0 200 40" width="100%" height="40"></svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const state = {
  properties: [],
  filtered: [],
  chat: [],
  isProcessing: false,
  sortMode: 'score_desc',
  currentPage: 1,
  pageSize: 15
};

function getApiBase(){
  try{
    return (window.location && window.location.protocol === 'file:') ? 'http://localhost:8000' : '';
  }catch(_){ return ''; }
}

function calculateScore(p) {
  let score = 0;
  const reasons = [];
  const dom = Number(p.daysOnMarket || 0);
  if (dom >= 240) { score += 70; reasons.push({text: `${dom}d on market`, color:'bg-danger text-white'}); }
  else if (dom >= 180) { score += 60; reasons.push({text: `${dom}d on market`, color:'bg-danger'}); }
  else if (dom >= 120) { score += 45; reasons.push({text: `${dom}d on market`, color:'bg-warning'}); }
  else if (dom >= 90)  { score += 35; reasons.push({text: `${dom}d on market`, color:'bg-orange text-white'}); }
  else if (dom >= 60)  { score += 22; reasons.push({text: `${dom}d on market`, color:'bg-info'}); }
  else if (dom >= 30)  { score += 12; reasons.push({text: `${dom}d on market`, color:'bg-info'}); }

  const price=Number(p.price||0);
  const original=Number(p.originalPrice||price||0);
  if(original>price&&original>0){
    const drop=(original-price)/original;
    if(drop>0.20){score+=20; reasons.push({text:'20%+ drop', color:'bg-danger'});} 
    else if(drop>0.10){score+=12; reasons.push({text:'10%+ drop', color:'bg-warning'});} 
  }
  if(price>0 && price<250000){score+=10; reasons.push({text:'Under $250k', color:'bg-success text-white'});} 

  const type=(p.homeType||'').toUpperCase();
  if(/MULTI|DUPLEX|TRIPLEX|FOURPLEX/.test(type)){score+=15; reasons.push({text:'Tired Landlord', color:'bg-purple text-white'});} 

  const textContent=`${p.description||''} ${p.streetAddress||''}`.toLowerCase();
  const keywords=['motivated','must sell','estate','probate','divorce','as is','fixer','tlc','power of sale','court order','relocating'];
  const hits=keywords.reduce((acc,kw)=>acc+(textContent.includes(kw)?1:0),0);
  if(hits>0){score+=hits*12; reasons.push({text:`Motivated ×${hits}`, color:'bg-red text-white'});} 

  score=Math.min(100, Math.round(score));
  const tier=score>=90?'S':score>=75?'A':score>=60?'B':'C';
  return {score,tier,reasons};
}

async function searchZillow(locationRaw){
  if(state.isProcessing) return;
  state.isProcessing=true;
  const location=(locationRaw||'').trim();
  if(!location){addMessage('bot','Include location'); state.isProcessing=false; return;}
  addMessage('bot',`Searching Zillow for: <strong>${escapeHtml(location)}</strong>...`);
  try{
    const base = getApiBase();
    const res = await fetch(`${base}/api/zillow?location=${encodeURIComponent(location)}`);

    let data=null;
    try { data = await res.json(); } catch { data = null; }

    if(!res.ok){
      const msg = (data && (data.error || data.details)) || `Network error (${res.status})`;
      throw new Error(msg);
    }

    const normalized=((data&&data.results)||[]).map(item=>{
      const addr=item.formattedAddress||item.address||item.streetAddress||'';
      const city=item.city||item.cityName||item.addressCity||'';
      const price=Number(item.price||item.listPrice||0);
      const img=item.photo||item.imgSrcHighRes||item.imgSrc||item.image||'';
      const detail=(item.detailUrl||item.url|| (item.zpid?`https://www.zillow.com/homedetails/${item.zpid}_zpid/`:'#'));
      // Prefer explicit time strings (e.g., "21 hours") over numeric DOM values
      const timeStr = item.time_on_zillow || item.timeOnZillow || item.timeOnSite || null;
      const numericDaysRaw = item.days_on_market ?? item.daysOnZillow ?? item.daysOnMarket ?? item.dom ?? null;

      let domDays = 0;
      let minutes = 0;

      function parseDurationToMinutes(str){
        if (!str || typeof str !== 'string') return 0;
        // normalize
        const s = String(str).toLowerCase();
        const m = s.match(/(\d+(?:\.\d+)?)/);
        const num = m ? Number(m[1]) : 0;
        if (/(min|minute|mins)/i.test(s)) return Math.max(0, Math.round(num));
        if (/(hr|hour|hrs)/i.test(s)) return Math.max(0, Math.round(num*60));
        if (/(day|days)/i.test(s)) return Math.max(0, Math.round(num*24*60));
        if (/ago/.test(s)){
          // If it says 'X ago' without unit, assume hours
          return Math.max(0, Math.round(num*60));
        }
        return 0;
      }

      if (timeStr) {
        minutes = parseDurationToMinutes(timeStr);
        domDays = Math.floor(minutes / (60*24));
      } else if (numericDaysRaw != null) {
        const n = Number(numericDaysRaw);
        if (!Number.isNaN(n) && n >= 0) {
          domDays = Math.round(n);
          minutes = domDays * 24 * 60;
        }
      }

      // If API provides a listing date, compute precise minutes as fallback
      if (!minutes) {
        const now = Date.now();
        const listedDateRaw = item.listing_date || item.listed_at || item.listingDate || item.datePosted || item.date_posted || item.listedAt || null;
        if (listedDateRaw){
          const ts = Date.parse(listedDateRaw);
          if (!Number.isNaN(ts)){
            const diffMin = Math.max(0, Math.floor((now - ts)/60000));
            minutes = diffMin;
            domDays = Math.floor(diffMin / (60*24));
          }
        }
      }
      // TEMP: debug first 3 items to verify minutes parsing
      if (!window.__mins_debug_count) window.__mins_debug_count = 0;
      if (window.__mins_debug_count < 3) {
        console.log('[mins-debug]', { timeStr, numericDaysRaw, minutes, domDays, listedDate: item.listing_date||item.listed_at||item.listingDate||item.datePosted||item.date_posted||item.listedAt||null, item });
        window.__mins_debug_count++;
      }

      // Bedrooms/Bathrooms from common fields
      const bedrooms = item.bedrooms ?? item.beds ?? item.bedRooms ?? null;
      const bathrooms = item.bathrooms ?? item.baths ?? item.bathRooms ?? null;

      return {
        _id:`${Date.now()}_${Math.random().toString(36).slice(2,9)}`,
        streetAddress: addr,
        city,
        price,
        priceDisplay: price?`$${price.toLocaleString()}`:'-',
        originalPrice: Number(item.originalPrice||price||0),
        bedrooms,
        bathrooms,
        daysOnMarket: domDays,
        minutesOnMarket: minutes,
        imgSrc: img,
        homeType: item.homeType || item.propertyType || '',
        description: item.publicRemarks || item.description || '',
        detailUrl: detail,
        zpid: item.zpid || null
      };
    });

    normalized.forEach(n=>{
      const scoreData=calculateScore(n);
      n.score=scoreData.score;
      n.tier=scoreData.tier;
      n.reasons=scoreData.reasons;
    });

    // Enrich minutes for items missing it using detail endpoint (limit to 10 to avoid rate limits)
    async function enrichMinutes(items, base){
      function parseDurationToMinutes(str){
        if (!str || typeof str !== 'string') return 0;
        const s=String(str).toLowerCase();
        const m=s.match(/(\d+(?:\.\d+)?)/); const num=m?Number(m[1]):0;
        if (/(min|minute|mins)/.test(s)) return Math.max(0, Math.round(num));
        if (/(hr|hour|hrs)/.test(s)) return Math.max(0, Math.round(num*60));
        if (/(day|days)/.test(s)) return Math.max(0, Math.round(num*24*60));
        return 0;
      }
      function findTimeString(obj){
        try{
          if (obj==null) return null;
          if (typeof obj === 'string'){
            const s=obj.toLowerCase();
            if (/(min|minute|mins|hr|hour|hrs|day|days)/.test(s)) return obj;
            return null;
          }
          if (Array.isArray(obj)){
            for (const v of obj){ const r=findTimeString(v); if(r) return r; }
            return null;
          }
          if (typeof obj === 'object'){
            for (const k of Object.keys(obj)){
              const v=obj[k];
              // prefer fields that look like time_on_zillow
              if (/time.*zillow/i.test(k) && typeof v==='string') return v;
              const r=findTimeString(v); if(r) return r;
            }
          }
        }catch(e){ /* ignore */ }
        return null;
      }

      const targets = items.filter(x=>(!x.minutesOnMarket||x.minutesOnMarket<=0) && x.zpid).slice(0,10);
      if(!targets.length) return;
      await Promise.all(targets.map(async (x)=>{
        try{
          // Try RapidAPI detail first
          let minutesFound = 0;
          const res=await fetch(`${base}/api/zillow/detail?zpid=${encodeURIComponent(x.zpid)}`);
          if(res.ok){
            const dj=await res.json();
            let timeStr = dj?.time_on_zillow || dj?.data?.time_on_zillow || dj?.result?.time_on_zillow || dj?.property?.time_on_zillow || dj?.property?.timeOnZillow || null;
            if(!timeStr) timeStr = findTimeString(dj);
            if(timeStr){ minutesFound = parseDurationToMinutes(timeStr); }
          }
          // Fallback: scrape the public detail page if still missing
          if(!minutesFound && x.detailUrl){
            try{
              const sres = await fetch(`${base}/api/zillow/scrape-time?url=${encodeURIComponent(x.detailUrl)}`);
              if(sres.ok){
                const sj = await sres.json();
                if (sj && typeof sj.minutes === 'number' && sj.minutes > 0) minutesFound = sj.minutes;
              }
            }catch(_){ /* ignore */ }
          }
          if(minutesFound>0) x.minutesOnMarket = minutesFound;
          else console.debug('[mins-enrich-miss]', {zpid:x.zpid, url:x.detailUrl});
        }catch(e){ console.debug('[mins-detail-error]', e); }
      }));
    }
    await enrichMinutes(normalized, base);

    state.properties=[...state.properties, ...normalized];
    state.currentPage = 1;
    saveData();
    filterAndRender();
    toast(`Loaded ${normalized.length} properties!`,'success');
  }catch(e){
    console.error(e);
    addMessage('bot',`Error fetching Zillow data: ${escapeHtml(e.message||'Unknown error')}`);
    toast('Check console','danger');
  }finally{state.isProcessing=false;}
}

async function searchRedfin(regionId){
  if(state.isProcessing) return;
  state.isProcessing = true;
  const id = String(regionId||'').trim();
  if(!id){ addMessage('bot', 'Provide a Redfin regionId. Example: <code>fetch redfin region 33_2924</code>'); state.isProcessing=false; return; }
  addMessage('bot',`Searching Redfin region <strong>${escapeHtml(id)}</strong>...`);
  try{
    const base = getApiBase();
    const res = await fetch(`${base}/api/redfin?regionId=${encodeURIComponent(id)}`);
    let json=null; try{ json = await res.json(); }catch{ json=null; }
    if(!res.ok){ const msg=(json&&json.error)||`Network error (${res.status})`; throw new Error(msg); }
    const list = (json && (json.results||json.data||json.items||[])) || [];
    const normalized = list.map((it,idx)=>{
      const addr = it.address || it.Address || it.location || it.streetAddress || '';
      const city = it.city || (it.Address && it.Address.city) || '';
      const priceRaw = it.price ?? it.PriceUnformattedValue ?? it.priceNum ?? it.Price ?? 0;
      const price = Number(priceRaw)||0;
      const img = it.imageUrl || it.img || it.imgSrc || (Array.isArray(it.photos)&&it.photos[0]?.url) || '';
      const detail = it.detailUrl || it.url || '#';
      const beds = it.beds ?? it.bedrooms ?? it.BedroomsTotal ?? null;
      const baths = it.baths ?? it.bathrooms ?? it.BathroomsTotal ?? null;
      const dom = Number(it.daysOnMarket ?? it.dom ?? it.daysOnZillow ?? 0) || 0;
      const n = {
        _id:`r_${Date.now()}_${idx}_${Math.random().toString(36).slice(2,7)}`,
        streetAddress: String(addr),
        city: String(city),
        price,
        priceDisplay: price?`$${price.toLocaleString()}`:'-',
        bedrooms: beds,
        bathrooms: baths,
        daysOnMarket: dom,
        minutesOnMarket: dom*24*60,
        imgSrc: img,
        homeType: it.type || it.propertyType || 'Property',
        description: it.remarks || it.description || '',
        detailUrl: detail
      };
      const sc = calculateScore(n); n.score=sc.score; n.tier=sc.tier; n.reasons=sc.reasons; return n;
    });
    state.properties = [...state.properties, ...normalized];
    state.currentPage = 1;
    saveData();
    filterAndRender();
    toast(`Loaded ${normalized.length} Redfin properties!`, 'success');
  }catch(e){ console.error(e); addMessage('bot',`Error: ${escapeHtml(e.message||'Unknown error')}`); toast('Check console','danger'); }
  finally{ state.isProcessing=false; }
}

function addMessage(sender, html){
  state.chat.push({sender,html});
  const box=document.getElementById('chatBox');
  const node=document.createElement('div');
  node.className=`msg ${sender}`;
  node.innerHTML=html;
  box.appendChild(node);
  box.scrollTop=box.scrollHeight;
}

function toast(msg,type='success'){
  const container=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className=`toast align-items-center text-bg-${type} border-0`;
  t.innerHTML=`<div class="d-flex"><div class="toast-body">${escapeHtml(msg)}</div><button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button></div>`;
  container.appendChild(t);
  new bootstrap.Toast(t,{delay:3500}).show();
  t.addEventListener('hidden.bs.toast',()=>t.remove());
}

function saveData(){
  try{localStorage.setItem('synapse_leads_v2',JSON.stringify(state.properties));}catch(e){console.warn(e);}
}
function loadData(){
  try{
    const raw=localStorage.getItem('synapse_leads_v2');
    if(raw){const arr=JSON.parse(raw); state.properties=Array.isArray(arr)?arr:[];}
  }catch(e){console.warn(e);}
}

function filterAndRender(){
  const q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
  const minScoreEl=document.getElementById('minScore');
  const minScore=Number((minScoreEl && minScoreEl.value) || 0);
  const sortMode = state.sortMode;
  state.filtered=state.properties
    .filter(p=>(Number(p.score||0)>=minScore))
    .filter(p=>!q||(String(p.streetAddress||'').toLowerCase().includes(q)||String(p.city||'').toLowerCase().includes(q)));
  if(sortMode==='dom_desc'){
    const minutes = p=> Number(((p.minutesOnMarket ?? (Number(p.daysOnMarket||0)*24*60)) || 0));
    state.filtered.sort((a,b)=> minutes(b) - minutes(a));
  } else {
    state.filtered.sort((a,b)=>Number(b.score||0)-Number(a.score||0));
  }
  // Clamp current page
  const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  if (state.currentPage > totalPages) state.currentPage = totalPages;
  if (state.currentPage < 1) state.currentPage = 1;
  renderTable();
  renderLiveStats();
}

function renderTable(){
  const tbody=document.getElementById('tableBody');
  tbody.innerHTML='';
  if(!state.filtered||state.filtered.length===0){tbody.innerHTML=`<tr><td colspan="9" class="text-center py-5 text-muted">No leads match your filters</td></tr>`;return;}
  const start = (state.currentPage - 1) * state.pageSize;
  const end = start + state.pageSize;
  const pageRows = state.filtered.slice(start, end);
  pageRows.forEach(p=>{
    const _reasons = Array.isArray(p.reasons) ? p.reasons : [];
    const _first = _reasons.slice(0, 4);
    const _extra = Math.max(0, _reasons.length - 4);
    const reasonsHTML = _first.map(r=>`<span class="reason-tag ${r.color||''}">${escapeHtml(r.text||'')}</span>`).join(' ') + (_extra ? ` <span class="reason-tag bg-secondary text-white">+${_extra} more</span>` : '');
    const sc = Number(p.score||0);
    const hue = Math.max(0, Math.min(120, Math.round((sc/100)*120))); // 0=red, 120=green
    const bg = `hsl(${hue}, 90%, 45%)`;
    const isDark = (document.documentElement.getAttribute('data-bs-theme')==='dark');
    const textColor = '#fff';
    const border = isDark ? '1px solid rgba(255,255,255,0.22)' : '1px solid rgba(0,0,0,0.15)';
    const shadow = isDark ? `0 0 0.35rem hsla(${hue}, 95%, 55%, 0.55)` : `0 0 0.15rem hsla(${hue}, 95%, 35%, 0.35)`;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><img src="${escapeAttr(p.imgSrc||'')}" class="thumb" onerror="this.src='https://via.placeholder.com/300'"></td>
      <td><strong>${escapeHtml(p.streetAddress||'')}</strong><br><small class="text-muted">${escapeHtml(p.city||'')}</small></td>
      <td class="text-end fw-bold">${escapeHtml(p.priceDisplay||'-')}</td>
      <td class="text-center">${escapeHtml(String(p.bedrooms??'-'))}</td>
      <td class="text-center">${escapeHtml(String(p.bathrooms??'-'))}</td>
      <td class="text-center"><strong>${escapeHtml(String(((p.minutesOnMarket ?? (Number(p.daysOnMarket||0)*24*60)) || 0).toLocaleString()))}</strong></td>
      <td class="text-center"><span class="badge score-badge" style="background:${bg}; color:${textColor}; border:${border}; box-shadow:${shadow};">${escapeHtml(String(sc))}</span></td>
      <td><div class="d-flex flex-wrap gap-1">${reasonsHTML||'<span class="text-muted">—</span>'}</div></td>
      <td>
        <button class="btn btn-sm btn-outline-warning me-1" onclick="prefillSimulator('${escapeAttr(p._id)}')">Sim</button>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="window.open('${escapeAttr(p.detailUrl||'#')}','_blank')">View</button>
        <button class="btn btn-sm btn-outline-danger" onclick="removeLead('${escapeAttr(p._id)}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  updatePager();
}

function updatePager(){
  const info = document.getElementById('pageInfo');
  const prev = document.getElementById('prevPage');
  const next = document.getElementById('nextPage');
  const jump = document.getElementById('pageJump');
  const total = state.filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
  if(info) info.textContent = `${state.currentPage} / ${totalPages}`;
  if(prev) prev.disabled = (state.currentPage<=1);
  if(next) next.disabled = (state.currentPage>=totalPages);
  if(jump){ jump.setAttribute('max', String(totalPages)); jump.value = String(state.currentPage); }
}

function goToPage(p){ state.currentPage = Math.max(1, p); renderTable(); }
function nextPage(){ state.currentPage += 1; renderTable(); }
function prevPage(){ state.currentPage -= 1; renderTable(); }
function jumpToPageInput(){
  const input = document.getElementById('pageJump');
  if(!input) return;
  const totalPages = Math.max(1, Math.ceil((state.filtered?.length||0) / state.pageSize));
  let n = Number(input.value)||1;
  if(n < 1) n = 1; if(n > totalPages) n = totalPages;
  state.currentPage = n; renderTable();
}

function removeLead(id){if(!confirm('Delete this lead?'))return; state.properties=state.properties.filter(x=>x._id!==id); saveData(); filterAndRender();}

function toCSV(rows){
  const esc=v=>`"${String(v??'').replaceAll('"','""')}"`;
  const header=['Address','City','Price','Beds','Baths','Minutes','Score','URL'];
  const lines=[header.map(esc).join(',')];
  rows.forEach(p=>{
    lines.push([
      p.streetAddress||'',
      p.city||'',
      p.price||'',
      p.bedrooms??'',
      p.bathrooms??'',
      ((p.minutesOnMarket ?? (Number(p.daysOnMarket||0)*24*60)) ?? ''),
      p.score??'',
      p.detailUrl||''
    ].map(esc).join(','));
  });
  return lines.join('\n');
}

function exportCSV(){
  const rows = state.filtered && state.filtered.length ? state.filtered : state.properties;
  if(!rows || rows.length===0){ toast('No rows to export','warning'); return; }
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `distressed_leads_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function clearTable(){
  if(!confirm('Clear all rows?')) return;
  state.properties=[]; state.filtered=[]; saveData(); filterAndRender();
  toast('Table cleared','success');
}

function sendTopToCarousel(){
  try{
    const items = (state.filtered && state.filtered.length ? state.filtered : state.properties) || [];
    if(!items.length){ toast('No properties to send','warning'); return; }
    const withImg = items.filter(p=>p && p.imgSrc && String(p.imgSrc).length>4);
    if(!withImg.length){ toast('No images available for carousel','warning'); return; }
    const top = withImg.slice(0,8);
    const mapped = top.map(p=>({
      address: [p.streetAddress||'', p.city||''].filter(Boolean).join(', '),
      photos: [{ url: p.imgSrc }],
      imageUrl: p.imgSrc,
      price: p.priceDisplay || (Number(p.price||0) ? `$${Number(p.price).toLocaleString()}` : 'N/A'),
      priceNum: Number(p.price||0),
      daysOnMarket: Number(p.daysOnMarket||Math.floor((Number(p.minutesOnMarket||0))/(60*24)))||0,
      distressScore: Number(p.score||0),
      propertyType: p.homeType || 'Property',
      detailUrl: p.detailUrl || '#'
    }));
    localStorage.setItem('eps_admin_properties', JSON.stringify(mapped));
    toast(`Sent ${mapped.length} to homepage carousel`, 'success');
  }catch(e){ console.warn(e); toast('Failed to send to carousel','danger'); }
}

function prefillsFrom(p){
  const $ = (id)=>document.getElementById(id);
  if(!$('sim_price')) return;
  $('sim_price').value = Number(p.price||0) || 0;
  $('sim_rent').value = Math.max(0, Math.round((Number(p.estimatedRent||0) || 0)));
  $('sim_arv').value = Number(p.price||0) || 0;
}

function prefillSimulator(id){
  try{
    const p = state.properties.find(x=>x._id===id);
    if(!p){ toast('Lead not found','warning'); return; }
    prefillsFrom(p);
    simulateDeal();
    toast('Simulator prefilled from row','success');
    document.getElementById('sim_price').scrollIntoView({behavior:'smooth', block:'center'});
  }catch(e){ console.warn(e); }
}

function simulateDeal(){
  const $ = (id)=>document.getElementById(id);
  const price = Number($('sim_price').value)||0;
  const rent = Number($('sim_rent').value)||0;
  const downPct = (Number($('sim_down').value)||0)/100;
  const rate = (Number($('sim_rate').value)||0)/100/12;
  const termY = Number($('sim_term').value)||30;
  const n = termY*12;
  const taxes = Number($('sim_taxes').value)||0;
  const ins = Number($('sim_ins').value)||0;
  const hoa = Number($('sim_hoa').value)||0;
  const vacPct = (Number($('sim_vac').value)||0)/100;
  const maintPct = (Number($('sim_maint').value)||0)/100;
  const mgmtPct = (Number($('sim_mgmt').value)||0)/100;
  const arv = Number($('sim_arv').value)||0;
  const rehab = Number($('sim_rehab').value)||0;
  const closingBuyPct = (Number($('sim_closing').value)||0)/100;
  const desiredProfit = Number($('sim_profit').value)||0;

  const down = price*downPct;
  const loan = Math.max(0, price - down);
  const pi = rate>0 ? (loan*rate*Math.pow(1+rate,n))/(Math.pow(1+rate,n)-1) : (loan/n);
  const piti = pi + taxes + ins + hoa;

  const gross = rent;
  const vacancy = gross*vacPct;
  const maint = gross*maintPct;
  const mgmt = gross*mgmtPct;
  const noiMonthly = gross - vacancy - taxes - ins - hoa - maint - mgmt;
  const capRate = price>0 ? (noiMonthly*12/price)*100 : 0;
  const dscr = pi>0 ? (noiMonthly/pi) : 0;

  const cashInvested = down + rehab + (price*closingBuyPct);
  const cashFlow = (gross - vacancy) - (piti + maint + mgmt);
  const coc = cashInvested>0 ? (cashFlow*12/cashInvested)*100 : 0;

  const mao = Math.max(0, (arv*0.70) - rehab - desiredProfit);

  const fmt=$=> isFinite($)? (typeof $==='number'? $: Number($)) : 0;
  const money = v=>`$${Math.round(fmt(v)).toLocaleString()}`;
  document.getElementById('out_pi').querySelector('.fw-bold').textContent = money(pi);
  document.getElementById('out_piti').querySelector('.fw-bold').textContent = money(piti);
  document.getElementById('out_dscr').querySelector('.fw-bold').textContent = (Math.round(dscr*100)/100).toFixed(2);
  document.getElementById('out_cap').querySelector('.fw-bold').textContent = `${(Math.round(capRate*10)/10).toFixed(1)}%`;
  document.getElementById('out_coc').querySelector('.fw-bold').textContent = `${(Math.round(coc*10)/10).toFixed(1)}%`;
  document.getElementById('out_cf').querySelector('.fw-bold').textContent = money(cashFlow);
  document.getElementById('out_mao').querySelector('.fw-bold').textContent = money(mao);
}

function initDealSim(){
  const form=document.getElementById('dealSimForm');
  if(!form) return;
  form.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input',()=>simulateDeal());
    inp.addEventListener('change',()=>simulateDeal());
  });
  simulateDeal();
}

function renderLiveStats(){
  try{
    const elC=document.getElementById('stat_count');
    if(!elC) return; // stats panel not present
    const items = state.filtered && state.filtered.length ? state.filtered : state.properties;
    const count = items.length;
    const avgScore = count? (items.reduce((a,b)=>a+Number(b.score||0),0)/count) : 0;
    const prices = items.map(p=>Number(p.price||0)).filter(x=>x>0).sort((a,b)=>a-b);
    const avgPrice = prices.length? (prices.reduce((a,b)=>a+b,0)/prices.length) : 0;
    const mins = items.map(p=>Number(p.minutesOnMarket ?? (Number(p.daysOnMarket||0)*24*60))).filter(x=>x>=0).sort((a,b)=>a-b);
    const medMins = mins.length? (mins[Math.floor(mins.length/2)]) : 0;

    elC.textContent = count.toLocaleString();
    document.getElementById('stat_avgscore').textContent = (Math.round(avgScore*10)/10).toFixed(1);
    document.getElementById('stat_avgprice').textContent = `$${Math.round(avgPrice).toLocaleString()}`;
    document.getElementById('stat_medmins').textContent = (medMins||0).toLocaleString();

    const spark = document.getElementById('stat_spark');
    const scores = items.slice(0,50).map(p=>Number(p.score||0));
    const max = Math.max(100, ...scores, 1);
    const step = 200/Math.max(1, scores.length-1);
    let d = '';
    scores.forEach((s,i)=>{
      const x = i*step;
      const y = 40 - (s/max)*40;
      d += (i===0?`M ${x},${y}`:` L ${x},${y}`);
    });
    spark.innerHTML = `<path d="${d}" fill="none" stroke="#22c55e" stroke-width="2"/><circle r="3" cx="${scores.length? (scores.length-1)*step:0}" cy="${scores.length? 40-(scores[scores.length-1]/max)*40:40}" fill="#22c55e"/>`;
  }catch(e){ console.warn('stats render failed', e); }
}

function parseCommand(input){
  if(!input)return null;
  const text=input.toLowerCase().trim();
  if(!/fetch|zillow|redfin|search/.test(text)) return null;
  if(/redfin/.test(text)){
    const rMatch = text.match(/region\s+([\w_\-]+)/);
    const region = rMatch ? rMatch[1] : '';
    return {action:'search_redfin', region};
  }
  const locMatch=text.match(/for\s+(.+?)(?=\s+(under|over|$))/)||text.match(/in\s+(.+?)(?=\s+(under|over|$))/)||text.match(/for\s+(.+)$/)||text.match(/in\s+(.+)$/);
  const location=locMatch?locMatch[1].trim():'';
  return {action:'search_zillow', location};
}

/* EVENTS */
document.getElementById('sendBtn').addEventListener('click',async()=>{
  const inputEl=document.getElementById('cmdInput');
  const text=inputEl.value.trim(); if(!text)return;
  addMessage('user',escapeHtml(text));
  inputEl.value='';
  const cmd=parseCommand(text);
  if(cmd){
    if(cmd.action==='search_redfin'){
      if(cmd.region) {
        await searchRedfin(cmd.region);
      } else {
        addMessage('bot','Provide a Redfin region id. Example: <code>fetch redfin region 33_2924</code>');
        toast('Use: fetch redfin region 33_2924','warning');
      }
    } else if(cmd.action==='search_zillow'){
      if(cmd.location) {
        await searchZillow(cmd.location);
      } else {
        addMessage('bot','Try: <code>fetch zillow for Edmonton AB under 400k</code>');
        toast('Use: fetch zillow for Edmonton AB under 400k','warning');
      }
    }
  } else {
    addMessage('bot','Try: <code>fetch zillow for Edmonton AB</code> or <code>fetch redfin region 33_2924</code>');
    toast('Unknown command. Try: fetch zillow for Calgary AB  |  fetch redfin region 33_2924','warning');
  }
});

document.getElementById('cmdInput').addEventListener('keydown', e=>{if(e.key==='Enter') document.getElementById('sendBtn').click();});
document.getElementById('clearChat').addEventListener('click',()=>{document.getElementById('chatBox').innerHTML=''; state.chat=[];});
document.getElementById('searchBox').addEventListener('input',()=>filterAndRender());
  const msEl=document.getElementById('minScore'); if(msEl) msEl.addEventListener('change',()=>filterAndRender());
  document.getElementById('sortSelect').addEventListener('change',(e)=>{state.sortMode=e.target.value; filterAndRender();});
  const exportBtn=document.getElementById('exportBtn'); if(exportBtn) exportBtn.addEventListener('click',exportCSV);
  const sendCarouselBtn=document.getElementById('sendCarouselBtn'); if(sendCarouselBtn) sendCarouselBtn.addEventListener('click',sendTopToCarousel);
  const clearBtn=document.getElementById('clearBtn'); if(clearBtn) clearBtn.addEventListener('click',clearTable);
  const pageSizeSel=document.getElementById('pageSizeSelect'); if(pageSizeSel){ pageSizeSel.addEventListener('change',()=>{ state.pageSize = Math.max(1, Number(pageSizeSel.value)||15); state.currentPage=1; renderTable(); }); }
  const pageJump=document.getElementById('pageJump'); if(pageJump){ pageJump.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); jumpToPageInput(); } }); }

  const themeBtn=document.getElementById('themeBtn');
  const themeIcon=themeBtn?themeBtn.querySelector('i'):null;
  function applyTheme(mode){
    document.body.classList.toggle('dark-mode', mode==='dark');
    document.body.classList.toggle('light-mode', mode!=='dark');
    document.documentElement.setAttribute('data-bs-theme', mode==='dark'?'dark':'light');
    if(themeIcon){
      themeIcon.classList.toggle('fa-moon', mode!=='dark');
      themeIcon.classList.toggle('fa-sun', mode==='dark');
    }
    localStorage.setItem('theme', mode);
  }
  const savedTheme=localStorage.getItem('theme');
  applyTheme(savedTheme==='dark'?'dark':'light');
  if(themeBtn){
    themeBtn.addEventListener('click',()=>{
      const next = (localStorage.getItem('theme')==='dark')?'light':'dark';
      applyTheme(next);
    });
  }

function escapeHtml(str){if(str===undefined||str===null)return''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");}
function escapeAttr(s){return escapeHtml(s).replace(/\n/g,'');}

function showPin(){
  const ov=document.getElementById('pinOverlay'); if(!ov) return;
  ov.classList.remove('hidden'); ov.setAttribute('aria-hidden','false');
  const input=document.getElementById('pinInput'); if(input) input.focus();
}
function hidePin(){
  const ov=document.getElementById('pinOverlay'); if(!ov) return;
  ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true');
}
function handlePinSubmit(){
  const input=document.getElementById('pinInput');
  const err=document.getElementById('pinError');
  const val=(input?.value||'').trim();
  const PIN='1381';
  if(val===PIN){ hidePin(); toast('Unlocked','success'); }
  else { if(err) err.textContent='Invalid PIN. Try again.'; input && input.select(); }
}

/* EVENTS */
document.addEventListener('DOMContentLoaded',()=>{
  // PIN gate: always require PIN each visit
  showPin();
  const pinBtn=document.getElementById('pinSubmit'); if(pinBtn) pinBtn.addEventListener('click', handlePinSubmit);
  const pinInput=document.getElementById('pinInput'); if(pinInput) pinInput.addEventListener('keydown',e=>{if(e.key==='Enter') handlePinSubmit();});

  // existing init
  loadData(); filterAndRender();
  initDealSim();
  addMessage('bot','Ready! Try: <code>fetch zillow for Edmonton AB</code>');
});
</script>
</body>
</html>
